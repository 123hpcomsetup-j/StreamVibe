<!DOCTYPE html>
<html>
<head>
    <title>Creator Overlay Validation Test</title>
    <script src="https://download.agora.io/sdk/web/AgoraRTC_N-4.23.4.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-box { 
            border: 2px solid #ddd; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
        }
        .success { border-color: #4CAF50; background: #f8fff8; }
        .error { border-color: #f44336; background: #fff8f8; }
        .info { border-color: #2196F3; background: #f8fbff; }
        button { 
            padding: 12px 24px; 
            margin: 8px; 
            border: none; 
            border-radius: 4px; 
            background: #2196F3; 
            color: white; 
            cursor: pointer; 
        }
        button:hover { background: #1976D2; }
        .log { font-family: monospace; font-size: 12px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Creator Overlay Validation Test</h1>
    <p>This test validates the exact same flow that the creator overlay uses.</p>
    
    <div class="test-box info">
        <h3>Current Stream Simulation</h3>
        <p>Channel: 8bfc6741-a428-430c-ba20-766c539efb0c (current active stream)</p>
        <p>Role: Creator (host)</p>
        <button onclick="runCreatorTest()">Test Creator Flow</button>
        <div id="creator-result"></div>
    </div>
    
    <div class="test-box info">
        <h3>Viewer Connection Test</h3>
        <p>Same channel as viewer perspective</p>
        <button onclick="runViewerTest()">Test Viewer Flow</button>
        <div id="viewer-result"></div>
    </div>
    
    <div class="test-box info">
        <h3>Authentication Analysis</h3>
        <button onclick="analyzeCredentials()">Analyze Credentials</button>
        <div id="analysis-result"></div>
    </div>

    <script>
        let logs = [];
        
        function log(message, elementId = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            logs.push(logMessage);
            console.log(logMessage);
            
            if (elementId) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.innerHTML += `<div class="log">${logMessage}</div>`;
                }
            }
        }
        
        async function runCreatorTest() {
            const resultDiv = document.getElementById('creator-result');
            resultDiv.innerHTML = '<div class="log">Starting creator test...</div>';
            
            try {
                const channelName = '8bfc6741-a428-430c-ba20-766c539efb0c';
                const uid = 770320000; // Same UID format as creator component
                
                log('Getting token for creator...', 'creator-result');
                
                const tokenResponse = await fetch('/api/agora/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        channelName: channelName,
                        uid: uid,
                        role: 'host'
                    })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error(`Token request failed: ${tokenResponse.status}`);
                }
                
                const tokenData = await tokenResponse.json();
                log(`Token received: ${tokenData.token.substring(0, 20)}...`, 'creator-result');
                log(`App ID: ${tokenData.appId}`, 'creator-result');
                
                // Create client exactly like creator component
                const client = AgoraRTC.createClient({ mode: 'live', codec: 'vp8' });
                client.setClientRole('host');
                
                log('Attempting to join channel as creator...', 'creator-result');
                await client.join(tokenData.appId, channelName, tokenData.token, uid);
                
                log('✅ SUCCESS: Creator joined successfully!', 'creator-result');
                resultDiv.classList.add('success');
                
                // Clean up
                setTimeout(async () => {
                    await client.leave();
                    log('Creator test completed and cleaned up', 'creator-result');
                }, 2000);
                
            } catch (error) {
                log(`❌ CREATOR ERROR: ${error.message}`, 'creator-result');
                resultDiv.classList.add('error');
                console.error('Creator test error:', error);
            }
        }
        
        async function runViewerTest() {
            const resultDiv = document.getElementById('viewer-result');
            resultDiv.innerHTML = '<div class="log">Starting viewer test...</div>';
            
            try {
                const channelName = '8bfc6741-a428-430c-ba20-766c539efb0c';
                const uid = 98708952; // Same UID format as viewer component
                
                log('Getting token for viewer...', 'viewer-result');
                
                const tokenResponse = await fetch('/api/agora/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        channelName: channelName,
                        uid: uid,
                        role: 'audience'
                    })
                });
                
                if (!tokenResponse.ok) {
                    throw new Error(`Token request failed: ${tokenResponse.status}`);
                }
                
                const tokenData = await tokenResponse.json();
                log(`Token received: ${tokenData.token.substring(0, 20)}...`, 'viewer-result');
                log(`App ID: ${tokenData.appId}`, 'viewer-result');
                
                // Create client exactly like viewer component
                const client = AgoraRTC.createClient({ mode: 'live', codec: 'vp8' });
                client.setClientRole('audience');
                
                log('Attempting to join channel as viewer...', 'viewer-result');
                await client.join(tokenData.appId, channelName, tokenData.token, uid);
                
                log('✅ SUCCESS: Viewer joined successfully!', 'viewer-result');
                resultDiv.classList.add('success');
                
                // Clean up
                setTimeout(async () => {
                    await client.leave();
                    log('Viewer test completed and cleaned up', 'viewer-result');
                }, 2000);
                
            } catch (error) {
                log(`❌ VIEWER ERROR: ${error.message}`, 'viewer-result');
                resultDiv.classList.add('error');
                console.error('Viewer test error:', error);
            }
        }
        
        async function analyzeCredentials() {
            const resultDiv = document.getElementById('analysis-result');
            resultDiv.innerHTML = '<div class="log">Analyzing credentials...</div>';
            
            try {
                // Test multiple different channels and UIDs
                const tests = [
                    { channel: 'test-1', uid: 12345, role: 'host' },
                    { channel: 'test-2', uid: 67890, role: 'audience' },
                    { channel: '8bfc6741-a428-430c-ba20-766c539efb0c', uid: 123456, role: 'host' }
                ];
                
                for (const test of tests) {
                    log(`Testing: ${test.channel} as ${test.role}`, 'analysis-result');
                    
                    const response = await fetch('/api/agora/token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            channelName: test.channel,
                            uid: test.uid,
                            role: test.role
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        log(`✓ Token generated: App ID ${data.appId}`, 'analysis-result');
                    } else {
                        log(`✗ Token failed: ${response.status}`, 'analysis-result');
                    }
                }
                
                log('Backend token generation is working correctly', 'analysis-result');
                log('Issue is likely browser cache or frontend environment variables', 'analysis-result');
                resultDiv.classList.add('success');
                
            } catch (error) {
                log(`Analysis error: ${error.message}`, 'analysis-result');
                resultDiv.classList.add('error');
            }
        }
        
        // Auto-run analysis on page load
        window.onload = function() {
            setTimeout(analyzeCredentials, 1000);
        };
    </script>
</body>
</html>